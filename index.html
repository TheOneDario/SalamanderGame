<!DOCTYPE html>

<html>

<head>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>

</head>

<body>

    <script>

    var config = {
        type: Phaser.AUTO,
        width: 1200,
        height: 700,
        physics: {
            default: 'arcade',
        },

        scene: {
            preload: preload,
            create: create,
            update: update,
            }


    };

    class Player extends Phaser.Physics.Arcade.Sprite
    {
        constructor(scene, x, y)
        {
            super(scene, x, y, 'player');
            scene.add.existing(this);
            scene.physics.add.existing(this);
            this.setScale(2);
            this.setCollideWorldBounds(true);
            this.setGravityY(3000); //We will set gravity *per object* rather than for the scene!
        }
    }

    class Slug extends Phaser.Physics.Arcade.Sprite
    {
        constructor(scene, x, y)
        {
            super(scene, x, y, 'slug');
            scene.add.existing(this);
            scene.physics.add.existing(this);
            this.setScale(0.4);
            this.setCollideWorldBounds(true);
            this.setGravityY(3000);
        }

        addTween(scene, xDist, yDist, time)
        {
            scene.tweens.add({ targets: this, x: xDist, y: yDist, duration: time, ease: 'Linear', repeat: -1, yoyo: true });
        }
    }

    class WingSlug extends Phaser.Physics.Arcade.Sprite
    {
          constructor(scene, x, y)
          {
             super(scene, x, y, 'wingslug');
             scene.add.existing(this);
             scene.physics.add.existing(this);
             this.setScale(0.4);
             this.setCollideWorldBounds(true);
             this.setGravityY(3000);
          }

          pathfind()
          {
                if (this.x < player.x) // If slug is too far left
                {
                      this.setVelocityX(180); // Move right
                }
                else if (this.x > player.x) // If slug is too far right
                {
                      this.setVelocityX(-180); // Move left
                }

                if ((this.y - player.y) > 10) // If more than 10px below player
                {
                      this.setVelocityY(-250); // Jump
                }
              }
            }

        class Fox extends Phaser.Physics.Arcade.Sprite
        {
            constructor(scene, x, y, spritesheet, animation)
            {
              super(scene, x, y, spritesheet, animation);
              scene.add.existing(this);
              scene.physics.add.existing(this);
              this.setScale(3);
              this.setCollideWorldBounds(true);
              this.play(animation);
            }
        }




    var game = new Phaser.Game(config);

    //Game Objects
    var platforms;
    var player;

    //Keyboard controls
    var cursors;
    var keys;
    var space;

    var MAX_JUMP_COUNT = 2;
    var currentJumps = MAX_JUMP_COUNT;

    var slugs = [];
    var wingSlugs = [];
    var bubbles = [];

    function preload()
    {
        this.load.image('sky', 'assets/bg.png');
        this.load.image('platform', 'assets/platform.png');
        this.load.image('player', 'assets/wabbit.png');
        this.load.image('slug', 'assets/slug.png');
        this.load.image('wingslug', 'assets/redslug.png');
        this.load.atlas('fox', 'assets/Fox_Sprite.png', 'assets/Fox_Sprite.json');

    }


    // Music credit: Music by Marllon Silva (xDeviruchi)

    /**
    TODO: Add bullets that can hit slugs
    TODO: Make camera follow player around the level
    TODO: Import tileset and level
    TODO: Win condition
    TODO: Maybe NPCs
    **/

    function create()
    {
        //Set the background origin to be at (0, 0) or top left corner of the image rather than the center of the image asset
       let background = this.add.tileSprite(0, 0, game.scale.width, game.scale.height, 'sky').setOrigin(0, 0);

       //Create the platforms and the player character set to collide with the platforms
       createPlatforms(this);
       player = new Player(this, 400, 400);
       this.physics.add.collider(player, platforms);
       player.setDepth(1);
       slug = new Slug(this, 600, 605.6);
       this.physics.add.overlap(slug, player);
       this.physics.add.collider(slug, platforms);
       slug.addTween(this, slug.x + 200, slug.y, 2000);
       slugs.push(slug); // add to list of slugs

       wingSlug = new WingSlug(this, 200, 605.6);
       this.physics.add.overlap(wingSlug, player);
       this.physics.add.collider(wingSlug, platforms);
       wingSlugs.push(wingSlug); // add to list of winged slugs

       //Set up user input
       cursors = this.input.keyboard.createCursorKeys();
       keys = this.input.keyboard.addKeys('A, D');
       space = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
       space.on('down', jump); //calls jump function when space is pressed

       this.anims.create({key: 'foxally', frames: this.anims.generateFrameNames('fox', {prefix: 'Fox', end: 4, zeroPad: 1}), repeat: -1
     });
       fox = new Fox(this, 185, 295, 'fox', 'foxally');



       createSpeechBubble(180, 210, 200, 50, 'â€œYEAHHHHH WOOOOO!"', this);


   }


       function createSpeechBubble (x, y, width, height, quote, scene)
       {
           var bubbleWidth = width;
           var bubbleHeight = height;
           var bubblePadding = 10;
           var arrowHeight = bubbleHeight / 4;

           var bubble = scene.add.graphics({ x: x, y: y });

           //  Bubble shadow
           bubble.fillStyle(0x222222, 0.5);
           bubble.fillRoundedRect(6, 6, bubbleWidth, bubbleHeight, 16);

           //  Bubble color
           bubble.fillStyle(0xffffff, 1);

           //  Bubble outline line style
           bubble.lineStyle(4, 0x565656, 1);

           //  Bubble shape and outline
           bubble.strokeRoundedRect(0, 0, bubbleWidth, bubbleHeight, 16);
           bubble.fillRoundedRect(0, 0, bubbleWidth, bubbleHeight, 16);

           //  Calculate arrow coordinates
           var point1X = Math.floor(bubbleWidth / 7);
           var point1Y = bubbleHeight;
           var point2X = Math.floor((bubbleWidth / 7) * 2);
           var point2Y = bubbleHeight;
           var point3X = Math.floor(bubbleWidth / 7);
           var point3Y = Math.floor(bubbleHeight + arrowHeight);


           //  Bubble arrow shadow
           bubble.lineStyle(4, 0x222222, 0.5);
           bubble.lineBetween(point2X - 1, point2Y + 6, point3X + 2, point3Y);

           //  Bubble arrow fill
           bubble.fillTriangle(point1X, point1Y, point2X, point2Y, point3X, point3Y);
           bubble.lineStyle(2, 0x565656, 1);
           bubble.lineBetween(point2X, point2Y, point3X, point3Y);
           bubble.lineBetween(point1X, point1Y, point3X, point3Y);

           var content = scene.add.text(0, 0, quote, { fontFamily: 'Arial', fontSize: 20, color: '#000000', align: 'center', wordWrap: { width: bubbleWidth - (bubblePadding * 2) } });

           var b = content.getBounds();

           content.setPosition(bubble.x + (bubbleWidth / 2) - (b.width / 2), bubble.y + (bubbleHeight / 2) - (b.height / 2));

    }



    function createPlatforms(scene)
    {
        platforms = scene.physics.add.staticGroup();

        //basePlatform is the floor of the game
        let basePlatform = platforms.create(game.scale.width/2, game.scale.height-30, 'platform');
        basePlatform.setScale(3, 1).refreshBody(); //scales the base platform in the x axis to cover the entire floor

        platforms.create(250, 350, 'platform'); //creates the upper left platform
        platforms.create(950, 500, 'platform'); //creates the bottome right platform
    }


    function update()
    {
        //Player will not move in the x-axis unless a movement key is being pressed
        player.setVelocityX(0);

        //Player has "drag" on the x-axis meaning they slide a bit after an input
        player.setDragX(1000);

        //Handle player movements
        if (cursors.left.isDown || keys.A.isDown)
        {
            player.setVelocityX(-400);
            //this.player.setAngle(-90);
        }

        if (cursors.right.isDown || keys.D.isDown)
        {
            player.setVelocityX(400);
            //this.player.setAngle(90);
        }

        for (let i = 0; i < wingSlugs.length; i++) // For each winged slug
        {
             wingSlugs[i].pathfind(); // Make each winger slug move towards player
        }
    }

    function jump(event)
    {
        if (player.body.touching.down)
        {
             currentJumps = MAX_JUMP_COUNT - 1;
            player.setVelocityY(-1100);
        }
        else if (currentJumps > 0)
        {
            currentJumps--;
            player.setVelocityY(-700);
       }

       function create ()
{

}
    }

    </script>

</body>

</html>
